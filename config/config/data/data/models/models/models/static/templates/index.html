<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOv8 Object Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-eye"></i> YOLOv8 Object Detection</h1>
            <p>Train, evaluate, and deploy state-of-the-art object detection models</p>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="#training" class="nav-link active" data-section="training">
                <i class="fas fa-dumbbell"></i> Training
            </a>
            <a href="#evaluation" class="nav-link" data-section="evaluation">
                <i class="fas fa-chart-line"></i> Evaluation
            </a>
            <a href="#inference" class="nav-link" data-section="inference">
                <i class="fas fa-camera"></i> Inference
            </a>
            <a href="#models" class="nav-link" data-section="models">
                <i class="fas fa-brain"></i> Models
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <!-- Training Section -->
        <section id="training" class="section active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Model Training</h2>
                    <p class="card-subtitle">Configure and start training your YOLOv8 model</p>
                </div>
                
                <div class="training-config">
                    <form id="training-form">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label" for="dataset">Dataset</label>
                                <select class="form-control form-select" id="dataset" name="dataset" required>
                                    <option value="">Select Dataset</option>
                                    <option value="coco">COCO (Common Objects in Context)</option>
                                    <option value="pascal_voc">PASCAL VOC</option>
                                </select>
                                <small class="text-muted">Choose the dataset for training</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="model_size">Model Size</label>
                                <select class="form-control form-select" id="model_size" name="model_size" required>
                                    <option value="n">YOLOv8n (Nano - Fastest)</option>
                                    <option value="s" selected>YOLOv8s (Small - Balanced)</option>
                                    <option value="m">YOLOv8m (Medium)</option>
                                    <option value="l">YOLOv8l (Large)</option>
                                    <option value="x">YOLOv8x (Extra Large - Most Accurate)</option>
                                </select>
                                <small class="text-muted">Larger models are more accurate but slower</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="epochs">Epochs</label>
                                <input type="number" class="form-control" id="epochs" name="epochs" 
                                       value="100" min="1" max="1000" required>
                                <small class="text-muted">Number of training epochs</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="batch_size">Batch Size</label>
                                <input type="number" class="form-control" id="batch_size" name="batch_size" 
                                       value="16" min="1" max="128" required>
                                <small class="text-muted">Images per batch (adjust based on GPU memory)</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="img_size">Image Size</label>
                                <select class="form-control form-select" id="img_size" name="img_size">
                                    <option value="320">320x320 (Fast)</option>
                                    <option value="416">416x416</option>
                                    <option value="512">512x512</option>
                                    <option value="640" selected>640x640 (Default)</option>
                                    <option value="832">832x832</option>
                                    <option value="1024">1024x1024 (High Quality)</option>
                                </select>
                                <small class="text-muted">Input image resolution</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="device">Device</label>
                                <select class="form-control form-select" id="device" name="device">
                                    <option value="auto" selected>Auto (Detect Best)</option>
                                    <option value="cpu">CPU</option>
                                    <option value="cuda">CUDA (GPU)</option>
                                </select>
                                <small class="text-muted">Training device</small>
                            </div>
                        </div>
                        
                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary btn-lg" id="start-training">
                                <i class="fas fa-play"></i> Start Training
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg ms-2" id="stop-training" style="display: none;">
                                <i class="fas fa-stop"></i> Stop Training
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Training Status -->
                <div class="training-status" id="training-status" style="display: none;">
                    <h3>Training Progress</h3>
                    <div class="progress">
                        <div class="progress-bar animated" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="training-metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="current-epoch">0</div>
                            <div class="metric-label">Current Epoch</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="total-epochs">100</div>
                            <div class="metric-label">Total Epochs</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="current-loss">0.000</div>
                            <div class="metric-label">Current Loss</div>
                        </div>
                        <div class="metric-card">
                            <div class="status" id="training-status-indicator">
                                <span class="status-dot"></span>
                                <span id="status-message">Ready</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Evaluation Section -->
        <section id="evaluation" class="section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Model Evaluation</h2>
                    <p class="card-subtitle">Evaluate trained models on validation datasets</p>
                </div>
                
                <form id="evaluation-form">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label" for="eval-model">Model</label>
                            <select class="form-control form-select" id="eval-model" name="model_path" required>
                                <option value="">Select Model</option>
                            </select>
                            <small class="text-muted">Choose a trained model to evaluate</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="eval-dataset">Dataset</label>
                            <select class="form-control form-select" id="eval-dataset" name="dataset" required>
                                <option value="coco">COCO</option>
                                <option value="pascal_voc">PASCAL VOC</option>
                            </select>
                            <small class="text-muted">Validation dataset</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-chart-bar"></i> Start Evaluation
                        </button>
                    </div>
                </form>
                
                <!-- Evaluation Results -->
                <div id="evaluation-results" style="display: none;">
                    <h3>Evaluation Results</h3>
                    <div class="grid grid-4">
                        <div class="metric-card">
                            <div class="metric-value" id="eval-map50">0.000</div>
                            <div class="metric-label">mAP@0.5</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="eval-map50-95">0.000</div>
                            <div class="metric-label">mAP@0.5:0.95</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="eval-precision">0.000</div>
                            <div class="metric-label">Precision</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="eval-recall">0.000</div>
                            <div class="metric-label">Recall</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Inference Section -->
        <section id="inference" class="section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Object Detection Inference</h2>
                    <p class="card-subtitle">Upload images and run object detection</p>
                </div>
                
                <form id="inference-form" enctype="multipart/form-data">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label" for="inference-model">Model</label>
                            <select class="form-control form-select" id="inference-model" name="model_path" required>
                                <option value="">Select Model</option>
                            </select>
                            <small class="text-muted">Choose a trained model for inference</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="image-file">Upload Image</label>
                            <div class="form-file">
                                <input type="file" id="image-file" name="file" accept="image/*" required>
                                <label for="image-file" class="form-file-label">
                                    <i class="fas fa-upload"></i> Choose Image
                                </label>
                            </div>
                            <small class="text-muted">Supported formats: JPG, PNG, GIF</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-info btn-lg">
                            <i class="fas fa-search"></i> Run Detection
                        </button>
                    </div>
                </form>
                
                <!-- Inference Results -->
                <div id="inference-results" style="display: none;">
                    <h3>Detection Results</h3>
                    <div class="grid grid-2">
                        <div class="image-container">
                            <img id="result-image" src="" alt="Detection Results">
                        </div>
                        <div>
                            <h4>Detections</h4>
                            <div id="detection-list"></div>
                            <h4 class="mt-4">Statistics</h4>
                            <div class="grid grid-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="num-detections">0</div>
                                    <div class="metric-label">Objects Found</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="inference-time">0</div>
                                    <div class="metric-label">Inference Time (ms)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Models Section -->
        <section id="models" class="section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Model Management</h2>
                    <p class="card-subtitle">View and manage your trained models</p>
                </div>
                
                <div id="models-list">
                    <div class="text-center p-5">
                        <i class="fas fa-brain fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No models available. Train a model first.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner"></div>
                    <h5 class="mt-3" id="loading-message">Processing...</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let trainingInterval = null;
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadModels();
            setupEventListeners();
        });

        // Event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    showSection(section);
                    
                    // Update active nav
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Training form
            document.getElementById('training-form').addEventListener('submit', function(e) {
                e.preventDefault();
                startTraining();
            });

            // Evaluation form
            document.getElementById('evaluation-form').addEventListener('submit', function(e) {
                e.preventDefault();
                startEvaluation();
            });

            // Inference form
            document.getElementById('inference-form').addEventListener('submit', function(e) {
                e.preventDefault();
                runInference();
            });

            // File input display
            document.getElementById('image-file').addEventListener('change', function() {
                const label = document.querySelector('label[for="image-file"]');
                if (this.files.length > 0) {
                    label.innerHTML = `<i class="fas fa-check"></i> ${this.files[0].name}`;
                } else {
                    label.innerHTML = '<i class="fas fa-upload"></i> Choose Image';
                }
            });
        }

        // Show section
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionName).style.display = 'block';
        }

        // Load available models
        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                const data = await response.json();
                
                const evalSelect = document.getElementById('eval-model');
                const inferenceSelect = document.getElementById('inference-model');
                const modelsList = document.getElementById('models-list');
                
                // Clear existing options
                evalSelect.innerHTML = '<option value="">Select Model</option>';
                inferenceSelect.innerHTML = '<option value="">Select Model</option>';
                
                if (data.models && data.models.length > 0) {
                    // Populate select options
                    data.models.forEach(model => {
                        const option1 = new Option(model.name, model.path);
                        const option2 = new Option(model.name, model.path);
                        evalSelect.add(option1);
                        inferenceSelect.add(option2);
                    });
                    
                    // Update models list
                    modelsList.innerHTML = data.models.map(model => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">${model.name}</h5>
                                        <p class="card-text text-muted">Size: ${(model.size / 1024 / 1024).toFixed(2)} MB</p>
                                    </div>
                                    <div>
                                        <a href="/api/download_model/${model.name}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    modelsList.innerHTML = `
                        <div class="text-center p-5">
                            <i class="fas fa-brain fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No models available. Train a model first.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading models:', error);
                showAlert('Error loading models', 'danger');
            }
        }

        // Start training
        async function startTraining() {
            const formData = new FormData(document.getElementById('training-form'));
            const data = Object.fromEntries(formData.entries());
            
            // Convert numeric values
            data.epochs = parseInt(data.epochs);
            data.batch_size = parseInt(data.batch_size);
            data.img_size = parseInt(data.img_size);
            
            try {
                showLoadingModal('Starting training...');
                
                const response = await fetch('/api/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                hideLoadingModal();
                
                if (response.ok) {
                    showAlert('Training started successfully!', 'success');
                    showTrainingStatus();
                    startTrainingStatusPolling();
                } else {
                    showAlert(result.error || 'Failed to start training', 'danger');
                }
            } catch (error) {
                hideLoadingModal();
                console.error('Error starting training:', error);
                showAlert('Error starting training', 'danger');
            }
        }

        // Show training status
        function showTrainingStatus() {
            document.getElementById('training-status').style.display = 'block';
            document.getElementById('start-training').style.display = 'none';
            document.getElementById('stop-training').style.display = 'inline-block';
            
            const statusIndicator = document.getElementById('training-status-indicator');
            statusIndicator.className = 'status status-info';
        }

        // Start training status polling
        function startTrainingStatusPolling() {
            trainingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/training_status');
                    const status = await response.json();
                    
                    updateTrainingStatus(status);
                    
                    if (!status.is_training) {
                        clearInterval(trainingInterval);
                        hideTrainingStatus();
                        loadModels(); // Refresh models list
                    }
                } catch (error) {
                    console.error('Error polling training status:', error);
                }
            }, 2000);
        }

        // Update training status
        function updateTrainingStatus(status) {
            document.getElementById('current-epoch').textContent = status.current_epoch;
            document.getElementById('total-epochs').textContent = status.total_epochs;
            document.getElementById('current-loss').textContent = status.current_loss.toFixed(4);
            document.getElementById('status-message').textContent = status.status_message;
            
            if (status.total_epochs > 0) {
                const progress = (status.current_epoch / status.total_epochs) * 100;
                document.getElementById('progress-bar').style.width = progress + '%';
            }
            
            const statusIndicator = document.getElementById('training-status-indicator');
            if (status.is_training) {
                statusIndicator.className = 'status status-info';
            } else {
                statusIndicator.className = status.status_message.includes('completed') ? 
                    'status status-success' : 'status status-warning';
            }
        }

        // Hide training status
        function hideTrainingStatus() {
            document.getElementById('start-training').style.display = 'inline-block';
            document.getElementById('stop-training').style.display = 'none';
        }

        // Start evaluation
        async function startEvaluation() {
            const formData = new FormData(document.getElementById('evaluation-form'));
            const data = Object.fromEntries(formData.entries());
            
            try {
                showLoadingModal('Evaluating model...');
                
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                hideLoadingModal();
                
                if (response.ok) {
                    showAlert('Evaluation completed!', 'success');
                    showEvaluationResults(result.metrics);
                } else {
                    showAlert(result.error || 'Evaluation failed', 'danger');
                }
            } catch (error) {
                hideLoadingModal();
                console.error('Error during evaluation:', error);
                showAlert('Error during evaluation', 'danger');
            }
        }

        // Show evaluation results
        function showEvaluationResults(metrics) {
            document.getElementById('evaluation-results').style.display = 'block';
            document.getElementById('eval-map50').textContent = (metrics.mAP50 || 0).toFixed(3);
            document.getElementById('eval-map50-95').textContent = (metrics['mAP50-95'] || 0).toFixed(3);
            document.getElementById('eval-precision').textContent = (metrics.precision || 0).toFixed(3);
            document.getElementById('eval-recall').textContent = (metrics.recall || 0).toFixed(3);
        }

        // Run inference
        async function runInference() {
            const formData = new FormData(document.getElementById('inference-form'));
            
            try {
                showLoadingModal('Running inference...');
                
                const response = await fetch('/api/inference', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                hideLoadingModal();
                
                if (response.ok) {
                    showAlert('Inference completed!', 'success');
                    showInferenceResults(result);
                } else {
                    showAlert(result.error || 'Inference failed', 'danger');
                }
            } catch (error) {
                hideLoadingModal();
                console.error('Error during inference:', error);
                showAlert('Error during inference', 'danger');
            }
        }

        // Show inference results
        function showInferenceResults(result) {
            document.getElementById('inference-results').style.display = 'block';
            
            if (result.image_data) {
                document.getElementById('result-image').src = result.image_data;
            }
            
            document.getElementById('num-detections').textContent = result.num_detections || 0;
            document.getElementById('inference-time').textContent = Math.round(result.inference_time_ms || 0);
            
            const detectionList = document.getElementById('detection-list');
            if (result.detections && result.detections.length > 0) {
                detectionList.innerHTML = result.detections.map(det => `
                    <div class="alert alert-info">
                        <strong>${det.class_name}</strong>: ${(det.confidence * 100).toFixed(1)}%
                    </div>
                `).join('');
            } else {
                detectionList.innerHTML = '<p class="text-muted">No objects detected</p>';
            }
        }

        // Utility functions
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showLoadingModal(message) {
            document.getElementById('loading-message').textContent = message;
            loadingModal.show();
        }

        function hideLoadingModal() {
            loadingModal.hide();
        }
    </script>
</body>
</html>
